<!DOCTYPE html>
<html>
<head>
  <title>Live Code</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="./highlight.min.js"></script>
  <script src="./diff.js"></script>
  <link rel="stylesheet" href="./solarized_dark.min.css">
  <style type="text/css">
    body {
      color: white;
    }
    pre {
      position: relative;
    }
    #changes {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    pre code {
      font-family: Menlo, Consolas, monospace;
    }
    .hl {
      display: inline-block;
      width: 100%;
      background-color: rgba(0, 0, 0, 0.17);
      border-left: solid 5px #8E8E8E;
      margin-left: -10px;
    }
  </style>
</head>
<body class="hljs" s>
  <pre><code id="main"></code><code id="changes"></code></pre>

  <script>
    var socket = io(document.location.href);
    var snapshots = [];

    socket.on('init', function(initialHistory) {
      snapshots = initialHistory;
      update();
    });
    socket.on('change', function(snapshot) {
      snapshots.push(snapshot);
      update();
    });

    function update() {
      var code = snapshots[snapshots.length - 1].content;
      main.innerHTML = hljs.highlight('javascript', code).value;

      if (snapshots.length <= 1) {
        return;
      }

      var diff = JsDiff.diffLines(
        snapshots[snapshots.length - 2].content,
        snapshots[snapshots.length - 1].content
      );

      changes.innerHTML = diff.map(function(part) {
        if (part.removed) {
          return '';
        }

        var placeholder = new Array(part.count + 1).join('&nbsp;\n');
        if (part.added) {
          return '<span class="hl">' + placeholder + '</span>';
        }

        return placeholder;
      }).join('');
    }
  </script>
</body>
</html>
